---
RecipeFormatVersion: '2020-01-25'
ComponentName: aws.greengrass.Nucleus
ComponentType: aws.greengrass.nucleus
ComponentDescription: Core functionality for device side orchestration of deployments and lifecycle management for execution of Greengrass components and applications.
ComponentPublisher: AWS
ComponentVersion: '0.0.0'
ComponentConfiguration:
  DefaultConfiguration:
    jvmOptions: -Xms512m -Xmx512m
    # TODO : Pending decision - Does thing name belong here?
    thingName: ""
    # TODO : Remove the ones without default, need to know how to declare a config
    #   without default but required
    iotDataEndpoint: ""
    iotCredEndpoint: ""
    privateKeyPath: ""
    certificateFilePath: ""
    rootCaPath: ""
    awsRegion: ""
    iotRoleAlias: ""
    mqtt: {}
    networkProxy: {}
    runWithDefault: {}
    deploymentPollingFrequency: 15L
    componentStoreMaxSize: 10_000_000_000L
Manifests:
  - Platform:
      os: darwin
    Artifacts:
      - URI: s3://gg-dev-artifacts/$componentName/$version/aws.greengrass.nucleus.zip
        Unarchive: zip
    Lifecycle:
      bootstrap:
          script: |-
            set -eu
            KERNEL_ROOT="{{kernel:rootPath}}"
            UNPACK_DIR="{{artifacts:decompressedPath}}/aws.greengrass.nucleus"
            # TODO: Use builtin unpack functionality with permission preserved if available
            chmod +x "$UNPACK_DIR/bin/loader"

            rm -r "$KERNEL_ROOT"/alts/current/*

            echo "{configuration:/jvmOptions}" > "$KERNEL_ROOT/alts/current/launch.params"
            ln -sf "$UNPACK_DIR" "$KERNEL_ROOT/alts/current/distro"
            exit 100

  - Platform:
      os: linux
    Artifacts:
      - URI: s3://gg-dev-artifacts/$componentName/$version/aws.greengrass.nucleus.zip
        Unarchive: zip
    Lifecycle:
      bootstrap:
        script: |-
          set -eu
          KERNEL_ROOT="{{kernel:rootPath}}"
          UNPACK_DIR="{{artifacts:decompressedPath}}/aws.greengrass.nucleus"
          # TODO: Use builtin unpack functionality with permission preserved if available
          chmod +x "$UNPACK_DIR/bin/loader"

          rm -r "$KERNEL_ROOT"/alts/current/*

          echo "{configuration:/jvmOptions}" > "$KERNEL_ROOT/alts/current/launch.params"
          ln -sf "$UNPACK_DIR" "$KERNEL_ROOT/alts/current/distro"
          exit 100
