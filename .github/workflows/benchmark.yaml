name: Benchmark

on:
  push:
    branches:
      - master

jobs:
  benchmark:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.evergreen_dev_snapshot_access_key_id }}
          aws-secret-access-key: ${{ secrets.evergreen_dev_snapshot_access_key_secret }}
          aws-region: us-west-2
      - uses: actions/cache@v1
        with:
          path: ~/.m2/repository
          # Only restore maven cache for this exact commit. If we start incrementing the version
          # of our Java SDK, then we can relax this to just the "hashFiles" and exclude "sha"
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
      - name: Build EG with Maven
        run: mvn -ntp install -DskipTests
      - name: Build benchmark with Maven
        run: mvn -ntp -f src/test/evergreen-kernel-benchmark install
      - name: JMH Benchmark
        # The JVM arguments provided below are intended to tune the JVM to keep the heap as small as possible
        # and to release unused heap space back to the OS
        # -foe is "fail on error" so that if an error happens, then the benchmark will be failed instead of silently
        # pass
        run: >-
          java -jar src/test/evergreen-kernel-benchmark/target/benchmarks.jar
          -rf json
          -foe true
          -jvmArgs "-Xms1m -Xmx64m -XX:MaxHeapFreeRatio=10 -XX:MinHeapFreeRatio=5 -XX:GCTimeRatio=19
          -XX:NativeMemoryTracking=summary -Xss232k"
          -prof com.aws.iot.evergreen.jmh.profilers.ForcedGcMemoryProfiler
      - name: Upload JMH Result
        uses: actions/upload-artifact@v1.0.0
        with:
          name: JMH Report
          path: jmh-result.json
      - name: Upload to CloudWatch
        run: >-
          pip3 -q install boto3 setuptools wheel &&
          pip3 -q install retryable agithub &&
          python3 .github/scripts/cwJMHUpload.py
