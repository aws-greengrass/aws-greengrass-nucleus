---
RecipeFormatVersion: '2020-01-25'
ComponentName: aws.greengrass.core
ComponentDescription: Core functionality for device side orchestration of deployments and life-cycle management for execution of Greengrass components and applications.
ComponentPublisher: AWS
ComponentVersion: '2.0.0'
Manifests:
  - Platform:
      os: macos
    Parameters:
      - name: jvmOptions
        # TODO: consider change to nested structure
        value: -Xms512m -Xmx512m
        type: STRING
    Artifacts:
      # TODO: set correct URI
      - URI: S3:GreengrassCore-2.0.0.zip
        Unarchive: zip
    Lifecycle:
      bootstrap:
          script: |-
            set -eu
            KERNEL_ROOT="{{kernel:rootPath}}"
            UNPACK_DIR="{{artifacts:decompressedPath}}/GreengrassCore-2.0.0"
            # TODO: Use builtin unpack functionality with permission preserved if available
            chmod +x "$UNPACK_DIR/bin/loader"

            rm -r "$KERNEL_ROOT"/alts/current/*

            echo "{{params:jvmOptions.value}}" > "$KERNEL_ROOT/alts/current/launch.params"
            ln -sf "$UNPACK_DIR" "$KERNEL_ROOT/alts/current/distro"
            exit 100

  - Platform:
      os: ubuntu
    Parameters:
      - name: jvmOptions
        # TODO: consider change to nested structure
        value: -Xms512m -Xmx512m
        type: STRING
    Artifacts:
      # TODO: set correct URI
      - URI: S3:GreengrassCore-2.0.0.zip
        Unarchive: zip
    Lifecycle:
      bootstrap:
        script: |-
          set -eu
          KERNEL_ROOT="{{kernel:rootPath}}"
          UNPACK_DIR="{{artifacts:decompressedPath}}/GreengrassCore-2.0.0"
          # TODO: Use builtin unpack functionality with permission preserved if available
          chmod +x "$UNPACK_DIR/bin/loader"

          rm -r "$KERNEL_ROOT"/alts/current/*

          echo "{{params:jvmOptions.value}}" > "$KERNEL_ROOT/alts/current/launch.params"
          ln -sf "$UNPACK_DIR" "$KERNEL_ROOT/alts/current/distro"
          exit 100